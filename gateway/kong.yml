_format_version: "3.0"
_transform: true

services:
  # 1. Auth Service (Public)
  - name: auth-service
    url: http://auth-service:8001
    routes:
      - name: auth-routes
        paths:
          - /auth
        strip_path: true
    plugins:
      - name: cors
        config:
          origins: ["*"] # Be more restrictive in production
          methods: ["GET", "POST", "OPTIONS"]
          headers: ["Content-Type", "Authorization"]
      - name: rate-limiting
        config:
          minute: 30
          policy: local

  # 2. User Service (JWT Protected)
  - name: user-service
    url: http://user-service:8002
    routes:
      - name: user-routes
        paths:
          - /users
        strip_path: true
    plugins:
      - name: jwt # Protects this route
      - name: cors
        config:
          origins: ["*"]
          methods: ["GET", "PUT", "POST", "DELETE", "OPTIONS"]
          headers: ["Content-Type", "Authorization"]
  
  # 3. Transaction Service (JWT Protected)
  - name: transaction-service
    url: http://transaction-service:8003
    routes:
      - name: transaction-routes
        paths:
          - /transactions
        strip_path: true
    plugins:
      - name: jwt
      - name: cors
        config:
          origins: ["*"]
          methods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"]
          headers: ["Content-Type", "Authorization"]
  
  # 4. Budget Service (JWT Protected)
  - name: budget-service
    url: http://budget-service:8004
    routes:
      - name: budget-routes
        paths:
          - /budgets
        strip_path: true
    plugins:
      - name: jwt
      - name: cors
        config:
          origins: ["*"]
          methods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"]
          headers: ["Content-Type", "Authorization"]
          
  # 5. Investment Service (JWT Protected)
  - name: investment-service
    url: http://investment-service:8005
    routes:
      - name: investment-routes
        paths:
          - /investments
        strip_path: true
    plugins:
      - name: jwt
      - name: cors
        config:
          origins: ["*"]
          methods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"]
          headers: ["Content-Type", "Authorization"]

  # 6. Debt Service (JWT Protected)
  - name: debt-service
    url: http://debt-service:8006
    routes:
      - name: debt-routes
        paths:
          - /debts
        strip_path: true
    plugins:
      - name: jwt
      - name: cors
        config:
          origins: ["*"]
          methods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"]
          headers: ["Content-Type", "Authorization"]
  
  # 7. Analytics Service (JWT Protected)
  - name: analytics-service
    url: http://analytics-service:8007
    routes:
      - name: analytics-routes
        paths:
          - /analytics
        strip_path: true
    plugins:
      - name: jwt
      - name: cors
        config:
          origins: ["*"]
          methods: ["GET", "OPTIONS"]
          headers: ["Content-Type", "Authorization"]
  
  # 8. AI/ML Service (JWT Protected)
  - name: ai-ml-service
    url: http://ai-ml-service:8009
    routes:
      - name: ai-ml-routes
        paths:
          - /ai
        strip_path: true
    plugins:
      - name: jwt
      - name: cors
        config:
          origins: ["*"]
          methods: ["GET", "POST", "OPTIONS"]
          headers: ["Content-Type", "Authorization"]
          
  # 9. Chat Service (JWT Protected)
  - name: chat-service
    url: http://chat-service:8010
    routes:
      - name: chat-routes
        paths:
          - /chat
        strip_path: true
    plugins:
      - name: jwt
      - name: cors
        config:
          origins: ["*"]
          methods: ["POST", "OPTIONS"]
          headers: ["Content-Type", "Authorization"]
      - name: rate-limiting
        config:
          minute: 20
          policy: local

# Global Kong Plugins
plugins:
  - name: prometheus # Expose metrics for Prometheus
  - name: correlation-id # Add a unique ID to each request for tracing
    config:
      header_name: "X-Correlation-ID"
      generator: "uuid"